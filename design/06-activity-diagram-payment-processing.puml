@startuml
title "活动图 - 支付处理流程"

|用户|
start
:在收银台页面进行支付;

|支付网关|
:处理支付请求;
:验证支付信息;
if (支付成功?) then (是)
  :扣款;
  :向系统发送异步回调通知;
  |用户|
  :同步跳转回商家成功页面;
else (否)
  :向系统发送异步回调通知;
  |用户|
  :同步跳转回商家失败页面;
  :查看支付失败原因;
  stop
endif

|系统|
:提供一个回调接口;
:接收支付网关的异步通知;
:使用签名验证通知的合法性;
if (签名合法?) then (是)
    :解析通知内容 (订单号, 金额, 支付状态);
    if (支付状态为成功?) then (是)
        :查询内部订单;
        if (订单状态为 'PENDING_PAYMENT'?) then (是)
            :更新订单状态为 'PAID';
            :通知仓储/物流系统准备发货;
            :向用户发送支付成功消息 (短信/邮件);
        else (已处理)
            :幂等性处理: 直接返回成功, 防止重复处理;
        endif
    else (支付状态为失败)
        :更新订单状态为 'PAYMENT_FAILED';
        :恢复之前锁定的库存;
    endif
else (不合法)
    :记录非法请求;
    :忽略该通知;
endif
stop

@enduml 